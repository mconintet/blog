##等待操作映射

这一节中我们将进一步探索 Vim 的映射系统中的兔子洞：“等待操作映射（operator-pending mappings）。”让我们停留一会以确保明白了字面的意思。

一个操作就是一个命令，它会等待你按下一个移动命令，然后在你当前的位置和将移动到的位置之间做一些操作。

一些关于操作的例子是 `d`，`y` 和 `c`。比如：

```
Keys   Operator   Movement
----   --------   -------------
dw     Delete     to next word
ci(    Change     inside parens
yt,    Yank       until comma
```

##移动型映射

Vim 可以让你创建可以与现有移动共存的新移动命令。运行下面的命令：

```vim
:onoremap p i(
```

现在把下面的文本输入缓冲区：

```
return person.get_pets(type="cat", fluffy_only=True)
```

将你的光标放到单词 `cat` 上然后按下 `dp`。发生了什么？Vim 删除了括号中的内容。你可以认为新的移动是“所有参数”。

`onoremap` 命令告诉 Vim 当其再等待一个操作的时候，如果输入了 `p` 就将其认为是 `i(`。当我们运行 `dp` 时看起来像是说 “删除参数”，Vim 将其翻译为 “删除括号中的内容”。

我们可以立刻将这个映射和所有的操作结合使用。在缓冲区中输入相同的内容（也可以简单的执行撤销编辑）：

```
return person.get_pets(type="cat", fluffy_only=True)
```

将你的光标放到单词 `cat` 上并输入 `cp`。发生了什么？Vim 删除了括号中的内容，不过这次将你带入了插入模式，因为你使用了“修改”而不是“删除”。

让我们是一个别的例子。运行下面的代码：

```vim
:onoremap b /return<cr>
```

现在将下面的文本输入到缓冲区：

```
def count(i):
    i += 1
    print i

    return foo
```

当你的光标放到第二行的 `i` 上面然后输入 `db`。发生了什么？Vim 删除了 `return` 之前的整个函数体，我们的映射通过使用了 Vim 的普通搜索去找到的 `return`。

当你试图去思考如何去定义一个新的操作等待型移动的时候，你可以这样去思考：

1. 以一个光标位置开始。
2. 进入可以模式。
3. ...映射你的按键以到达这里...
4. 所有你希望移动会包括的内容现在都已经被选中了。

你的任务就是为第三步填上合适的按键。

##改变起始位置

你可以能已经注意到这个问题，如果你的移动总是需要以当前光标所在的位置为起点的话，会限制我们可以做的事情。

Vim 是没有限制你的习惯的，所以对于这个问题一定有一个解决方案。运行下面的命令：

```vim
:onoremap in( :<c-u>normal! f(vi(<cr>
```

这样看起来有点吓人，不过我们先试试它。在缓冲区中输入下面的文本：

```
print foo(bar)
```

将你的光标放置到 `print` 这个单词中的任意位置然后按下 `cin(`。Vim 将会删除括号中的内容并将你带到括号中间进入插入模式。

你可以认为这个映射的意思是“在接下来的括号中”，它将会在当前行的接下来的括号中执行操作。

让我们创建一个成对的 “在上一个（last）括号中”（”之前的（previous）或许是一个更好的词，但是它会隐藏段落（paragraph）移动的意思“）。运行下面的代码：

```
:onoremap il( :<c-u>normal! F)vi(<cr>
```

在你的文本中试一试去确保它确实工作了。

所以这些映射如何工作的？首先，`<c-u>` 是一些你可以现在暂时忽略的东西 -- 只要相信我它需要放在那使得映射可以工作。如果移除的话：

```vim
:normal! F)vi(<cr>
```

`:normal!` 我们将在下一节中讨论，但是现在可以知道，这是一个可以模拟普通模式按键的命令。比如：`:normal! dddd` 将会删除两行，就好像按下了 `dddd`。映射最后的 `<cr>` 就是用于运行这个 `:normal!` 命令的。

所以我们现在知道了那个映射本质上就是运行下面的一组按键：

```
F)vi(
```

这是非常简单的：
- `F)`：向后移动到最近的 `)` 字符。
- `vi(`：可视选择括号中的内容。

我们以一些被我们可视选中的想要对其操作的部分作为结束，接着 Vim 像往常一样执行操作。

##一般规则

一种保持创建的操作等待映射直观的方式是记住下面的两个规则：
- 如果你的操作等待映射以一些被可视选中的文本结束的话，Vim 将会在那些文本上进行操作
- 否则的话，Vim 对原有的光标位置和新光标位置之间的文本进行操作。

##练习

为”下一个括号（包括括号）“和“上一个括号（包括括号）“创建操作等待映射。

为大括号创建类似的包括、不包括括号的操作等待映射。

阅读 `:help omap-info` 并看看自己能否思索出 `<c-u>` 在上面的例子中的意思。
